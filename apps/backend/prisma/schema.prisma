// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Base user for all roles
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  avatar    String?
  role      UserRole
  status    UserStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  patient           Patient?
  doctor            Doctor?
  consultations     Consultation[] @relation("DoctorConsultations")
  appointments      Appointment[] @relation("DoctorAppointments")
  prescriptions     Prescription[] @relation("DoctorPrescriptions")

  @@index([email])
  @@index([role])
}

enum UserRole {
  ADMIN
  DOCTOR
  PATIENT
  RECEPTIONIST
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// Patient model
model Patient {
  id                String   @id @default(cuid())
  userId            String   @unique
  dateOfBirth       DateTime
  gender            Gender
  bloodGroup        BloodGroup?
  address           String
  city              String
  state             String
  postalCode        String
  country           String
  phone             String
  emergencyContact  String?
  allergies         String?
  chronicDiseases   String?
  notes             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  consultations     Consultation[] @relation("PatientConsultations")
  appointments      Appointment[] @relation("PatientAppointments")
  medicalRecords    MedicalRecord[]
  prescriptions     Prescription[] @relation("PatientPrescriptions")
  invoices          Invoice[] @relation("PatientInvoices")

  @@index([userId])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodGroup {
  O_POSITIVE
  O_NEGATIVE
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
}

// Doctor model
model Doctor {
  id               String   @id @default(cuid())
  userId           String   @unique
  specialization   String
  licenseNumber    String   @unique
  yearsExperience  Int
  qualifications   String
  clinicAddress    String?
  consultationFee  Float    @default(0)
  bio              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  consultations    Consultation[] @relation("DoctorConsultations")
  appointments     Appointment[] @relation("DoctorAppointments")
  prescriptions    Prescription[] @relation("DoctorPrescriptions")
  availability     DoctorAvailability[]

  @@index([userId])
  @@index([specialization])
}

// Doctor Availability for scheduling
model DoctorAvailability {
  id           String   @id @default(cuid())
  doctorId     String
  dayOfWeek    Int      // 0-6 (Sunday-Saturday)
  startTime    String   // HH:mm format
  endTime      String   // HH:mm format
  isAvailable  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  doctor       Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, dayOfWeek])
  @@index([doctorId])
}

// Appointment model
model Appointment {
  id               String   @id @default(cuid())
  patientId        String
  doctorId         String
  appointmentDate  DateTime
  appointmentTime  String
  status           AppointmentStatus @default(PENDING)
  notes            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  patient          Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade, name: "PatientAppointments")
  doctor           User     @relation(fields: [doctorId], references: [id], onDelete: Cascade, name: "DoctorAppointments")
  consultation     Consultation?

  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  RESCHEDULED
}

// Consultation model
model Consultation {
  id            String   @id @default(cuid())
  appointmentId String?  @unique
  patientId     String
  doctorId      String
  scheduledAt   DateTime
  duration      Int      // in minutes
  status        ConsultationStatus @default(SCHEDULED)
  complaints    String
  diagnosis     String?
  prescription  String?
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade, name: "PatientConsultations")
  doctor        User     @relation(fields: [doctorId], references: [id], onDelete: Cascade, name: "DoctorConsultations")
  prescriptions Prescription[]

  @@index([patientId])
  @@index([doctorId])
  @@index([status])
}

enum ConsultationStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// Prescription model
model Prescription {
  id             String   @id @default(cuid())
  consultationId String?
  patientId      String
  doctorId       String
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  consultation   Consultation? @relation(fields: [consultationId], references: [id], onDelete: SetNull)
  patient        Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade, name: "PatientPrescriptions")
  doctor         User     @relation(fields: [doctorId], references: [id], onDelete: Cascade, name: "DoctorPrescriptions")
  items          PrescriptionItem[]

  @@index([patientId])
  @@index([doctorId])
  @@index([consultationId])
}

// Prescription Item - individual medicine entries
model PrescriptionItem {
  id             String   @id @default(cuid())
  prescriptionId String
  medicineName   String
  potency        String   // e.g., "30C", "200C"
  dosage         String   // e.g., "5 drops", "1 tablet"
  frequency      String   // e.g., "3 times daily"
  duration       String   // e.g., "10 days", "2 weeks"
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  prescription   Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  @@index([prescriptionId])
}

// Medical Records - store file references
model MedicalRecord {
  id          String   @id @default(cuid())
  patientId   String
  title       String
  description String?
  fileUrl     String
  recordType  String   // lab_report, x_ray, prescription, etc.
  recordedAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([recordType])
}

// Invoice/Billing
model Invoice {
  id              String   @id @default(cuid())
  patientId       String
  consultationId  String?
  amount          Float
  description     String
  paymentStatus   PaymentStatus @default(PENDING)
  dueDate         DateTime?
  paidDate        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  patient         Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade, name: "PatientInvoices")

  @@index([patientId])
  @@index([paymentStatus])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Audit Log - for security and compliance
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}
